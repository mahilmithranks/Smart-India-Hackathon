<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Dustbin Dashboard — Modern</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #2563eb;
      --accent-light: #dbeafe;
      --ok: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --bg: #f9fafb;
      --card: #ffffff;
      --muted: #6b7280;
      --shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: #111827;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px;
      background: var(--accent);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    header .sub {
      font-size: 14px;
      opacity: 0.9;
    }
    header button {
      padding: 8px 14px;
      border: none;
      border-radius: 10px;
      background: white;
      color: var(--accent);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    header button:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
    }

    /* Layout */
    .container {
      padding: 24px;
      max-width: 1280px;
      margin: auto;
    }
    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      margin-bottom: 20px;
    }
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .card h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
      font-weight: 500;
      color: var(--muted);
    }
    .big {
      font-size: 32px;
      font-weight: 700;
    }
    .muted {
      color: var(--muted);
      font-size: 14px;
    }
    #map {
      height: 420px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
    }
    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    /* Alerts */
    .alerts-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .alert-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      background: #fff5f5;
      border: 1px solid #fee2e2;
      transition: transform 0.2s ease;
    }
    .alert-item:hover {
      transform: translateX(2px);
    }
    .alert-item strong {
      color: var(--danger);
    }
    .small-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: var(--accent);
      color: white;
      font-size: 14px;
      transition: all 0.2s;
    }
    .small-btn:hover {
      background: #1d4ed8;
    }

    /* Recent bins */
    #recentContainer div {
      padding: 8px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    /* Chart */
    canvas {
      background: var(--card);
      padding: 16px;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    /* Footer */
    footer {
      margin-top: 20px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Smart Dustbin — Dashboard</h1>
      <div class="sub">Panchayat Monitoring • Real-time fill levels</div>
    </div>
    <div>
      <button id="simulateBtn">Simulate live data</button>
    </div>
  </header>

  <main class="container">
    <section class="grid" id="topCards">
      <div class="card">
        <h3>Total Bins</h3>
        <div class="big" id="totalBins">—</div>
        <div class="muted">Installed smart dustbins</div>
      </div>

      <div class="card">
        <h3>Bins ≥ 80% (Urgent)</h3>
        <div class="big" id="fullBins">—</div>
        <div class="muted">Require immediate cleaning</div>
      </div>

      <div class="card">
        <h3>Average Fill</h3>
        <div class="big" id="avgFill">—%</div>
        <div class="muted">Average fill level across all bins</div>
      </div>

      <div class="card">
        <h3>Last Update</h3>
        <div class="big" id="lastUpdate">—</div>
        <div class="muted">Most recent data timestamp</div>
      </div>
    </section>

    <section class="layout">
      <div>
        <div id="map" class="card"></div>
        <div style="margin-top:20px;">
          <canvas id="trendChart" height="120"></canvas>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3>Alerts & Actions</h3>
          <div class="muted" style="margin-bottom:8px;">Bins that need cleaning (level ≥ 80%)</div>
          <div class="alerts-list" id="alertsContainer"></div>
        </div>

        <div style="height:20px;"></div>

        <div class="card">
          <h3>Recent Bins</h3>
          <div id="recentContainer" class="muted"></div>
        </div>
      </aside>
    </section>

    <footer>Prototype — dummy data. Next: integrate with ESP32 (MQTT/HTTP) + backend API.</footer>
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ---------- Dummy data ----------
  let bins = [
    { id: 'B-101', lat: 12.9716, lng: 77.5946, level: 85, updated: '2025-09-08 10:12' },
    { id: 'B-102', lat: 12.9720, lng: 77.5955, level: 45, updated: '2025-09-08 09:58' },
    { id: 'B-103', lat: 12.9707, lng: 77.5933, level: 62, updated: '2025-09-08 09:40' },
    { id: 'B-104', lat: 12.9695, lng: 77.5950, level: 28, updated: '2025-09-08 08:55' },
    { id: 'B-105', lat: 12.9732, lng: 77.5940, level: 92, updated: '2025-09-08 10:00' }
  ];

  // ---------- Utility ----------
  function formatDate(d) {
    return d.getFullYear() + '-' +
      String(d.getMonth()+1).padStart(2,'0') + '-' +
      String(d.getDate()).padStart(2,'0') + ' ' +
      String(d.getHours()).padStart(2,'0') + ':' +
      String(d.getMinutes()).padStart(2,'0');
  }

  function computeStats(arr){
    const total = arr.length;
    const full = arr.filter(b=>b.level >= 80).length;
    const avg = Math.round(arr.reduce((s,b)=>s+b.level,0)/Math.max(1,arr.length));
    const last = arr.map(b=>b.updated).sort().reverse()[0] || '—';
    return { total, full, avg, last };
  }

  // ---------- Top Cards ----------
  function renderCards(){
    const s = computeStats(bins);
    document.getElementById('totalBins').textContent = s.total;
    document.getElementById('fullBins').textContent = s.full;
    document.getElementById('avgFill').textContent = s.avg + '%';
    document.getElementById('lastUpdate').textContent = s.last;
  }

  // ---------- Map ----------
  let map, markers = [];
  function colorForLevel(level){
    if(level >= 80) return '#ef4444';
    if(level >= 50) return '#facc15';
    return '#22c55e';
  }
  function renderMap(){
    if(!map){
      const avgLat = bins.reduce((s,b)=>s+b.lat,0)/bins.length;
      const avgLng = bins.reduce((s,b)=>s+b.lng,0)/bins.length;
      map = L.map('map').setView([avgLat, avgLng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);
    }
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    bins.forEach(b => {
      const circle = L.circleMarker([b.lat,b.lng], {
        radius: 10,
        fillOpacity: 0.9,
        color: '#222',
        weight: 0.6,
        fillColor: colorForLevel(b.level)
      }).addTo(map);
      circle.bindPopup(`<strong>${b.id}</strong><br/>Fill: ${b.level}%<br/>Updated: ${b.updated}`);
      markers.push(circle);
    });
  }

  // ---------- Alerts ----------
  function renderAlerts(){
    const container = document.getElementById('alertsContainer');
    container.innerHTML = '';
    const urgent = bins.filter(b=>b.level >= 80).sort((a,b)=>b.level-a.level);
    if(urgent.length === 0){
      container.innerHTML = '<div class="muted">No urgent bins right now.</div>';
      return;
    }
    urgent.forEach(b=>{
      const item = document.createElement('div');
      item.className = 'alert-item';
      item.innerHTML = `<div><strong>${b.id}</strong><br/><span class="muted">Fill: ${b.level}% • ${b.updated}</span></div>
                        <button class="small-btn" onclick="dispatch('${b.id}')">Dispatch</button>`;
      container.appendChild(item);
    });
  }

  function dispatch(binId){
    alert('Dispatch action requested for ' + binId + '. (Hook this to backend task assignment.)');
  }

  // ---------- Recent ----------
  function renderRecent(){
    const rc = document.getElementById('recentContainer');
    rc.innerHTML = bins.slice().sort((a,b)=>b.updated.localeCompare(a.updated)).slice(0,5).map(b=>{
      return `<div><strong>${b.id}</strong> — ${b.level}% <div class="muted">${b.updated}</div></div>`;
    }).join('');
  }

  // ---------- Chart ----------
  let trendChart = null;
  function renderChart(){
    const labels = ['-6d','-5d','-4d','-3d','-2d','-1d','Today'];
    const base = bins.reduce((s,b)=>s+b.level,0)/bins.length;
    const data = labels.map((l,i)=> Math.max(10, Math.min(100, Math.round(base + (Math.sin(i)+Math.random())*6))));
    const ctx = document.getElementById('trendChart').getContext('2d');
    if(trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets:[{ label:'Avg fill %', data, tension:0.35, fill:true, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.1)' }]},
      options: {
        scales:{ y:{ beginAtZero:true, max:100 } },
        plugins:{ legend:{ display:false } }
      }
    });
  }

  // ---------- Update UI ----------
  function updateUI(){
    renderCards();
    renderMap();
    renderAlerts();
    renderRecent();
    renderChart();
  }
  updateUI();

  // ---------- Simulation ----------
  let sim = false, simInterval=null;
  document.getElementById('simulateBtn').addEventListener('click', ()=>{
    sim = !sim;
    document.getElementById('simulateBtn').textContent = sim ? 'Stop simulation' : 'Simulate live data';
    if(sim) startSim(); else stopSim();
  });

  function startSim(){
    simInterval = setInterval(()=>{
      const idx = Math.floor(Math.random()*bins.length);
      const change = Math.round((Math.random()-0.4)*20);
      bins[idx].level = Math.min(100, Math.max(0, bins[idx].level + change));
      bins[idx].updated = formatDate(new Date());
      updateUI();
    }, 4000);
  }
  function stopSim(){ clearInterval(simInterval); simInterval=null; }

  window.dispatch = dispatch;
  </script>
</body>
</html>
